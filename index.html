<!DOCTYPE html>
<html>
<head>
  <title>USDC AI Onboarding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background:#f4f6f8; padding:20px; display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; }
    .card { width:100%; max-width: 500px; background:#fff; padding:30px; border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.1); text-align:center; position:relative; }
    
    h2 { color:#333; margin-bottom:15px; }
    input, button { width:100%; padding:12px 15px; margin-top:12px; font-size:16px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    input:focus { border-color:#007bff; outline:none; }
    
    button { background:#007bff; color:#fff; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
    button:hover { background:#0056b3; }
    button:disabled { background:#ccc; cursor:not-allowed; }
    
    #aiSection { margin-top:20px; display:none; }
    #aiText { font-size:18px; color:#444; line-height:1.6; min-height:80px; font-style:italic; margin-top:15px; background: #f9f9f9; padding: 15px; border-radius: 8px; }
    
    /* Ask Button */
    #askBtn { background:#ff9800; display:none; margin-top:20px; box-shadow: 0 4px 10px rgba(255, 152, 0, 0.3); }
    #askBtn:hover { background:#e68900; }
    #askBtn:active { transform: scale(0.98); }

    /* Animations */
    .wave { height: 30px; display:none; justify-content:center; align-items:flex-end; gap:5px; margin-top:20px; }
    .bar { width:6px; height:10px; background:#007bff; animation: bounce 0.5s infinite alternate; }
    .bar:nth-child(2) { animation-delay:0.1s; }
    .bar:nth-child(3) { animation-delay:0.2s; }
    @keyframes bounce { to { height: 30px; opacity: 0.5; } }
  </style>
</head>

<body>

<div class="card">
  <!-- FORM -->
  <div id="formSection">
    <h2>Welcome to USDC</h2>
    <input id="nameInput" placeholder="Full Name">
    <input id="emailInput" placeholder="Email Address">
    <input id="roleInput" placeholder="Role / Department">
    <button onclick="startOnboarding()">Start Onboarding</button>
  </div>

  <!-- AI -->
  <div id="aiSection">
    <h3>AI Assistant</h3>
    <div class="wave" id="voiceWave">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    <div id="aiText">Connecting...</div>
    
    <!-- INTERRUPT BUTTON -->
    <button id="askBtn" onclick="askDoubt()">âœ‹ Push to Ask Doubt</button>
  </div>
</div>

<script>
/* ðŸ”´ PASTE YOUR DEPLOYED WEB APP URL HERE */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzY0CuQFdIBOopTEKOlWyjKlCIJ5N0v4ifoZiU_wpaKUOcuFgY5oUO0WvXy5L0FuQbP6A/exec";

let stepIndex = 0;
let onboardingSteps = [];
let synth = window.speechSynthesis;
let recognition;
let isPaused = false;
let userInfo = {};

/* ================== START ================== */
function startOnboarding() {
  const name = document.getElementById("nameInput").value.trim();
  const email = document.getElementById("emailInput").value.trim();
  const role = document.getElementById("roleInput").value.trim();

  if (!name || !email || !role) { alert("Please fill all details"); return; }
  
  userInfo = { name, email, role };

  // UI Updates
  document.getElementById("formSection").style.display = "none";
  document.getElementById("aiSection").style.display = "block";
  document.getElementById("voiceWave").style.display = "flex";
  
  // 1. Speak greeting immediately
  speak(`Hello ${name}. Welcome to USDC. Retrieving your onboarding policy...`);

  // 2. Fetch Summary Steps from Backend
  fetch(`${BACKEND_URL}?action=start&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}&role=${encodeURIComponent(role)}`, { 
      method: "POST" 
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      onboardingSteps = data.steps;
      document.getElementById("askBtn").style.display = "block"; 
      setTimeout(nextStep, 1000); // Start reading steps
    }
  })
  .catch(err => {
    speak("Sorry, connection to server failed.");
  });
}

/* ================== FLOW LOGIC ================== */
function nextStep() {
  if (isPaused) return; 

  if (stepIndex < onboardingSteps.length) {
    speak(onboardingSteps[stepIndex], true);
    stepIndex++;
  } else {
    speak("Onboarding completed. Welcome to the team!");
    document.getElementById("askBtn").style.display = "none";
    document.getElementById("voiceWave").style.display = "none";
  }
}

/* ================== INTERRUPTION LOGIC ================== */
function askDoubt() {
  isPaused = true;
  synth.cancel(); // Stop talking
  
  document.getElementById("aiText").innerText = "Listening... (Speak now)";
  document.getElementById("askBtn").innerText = "Listening...";
  document.getElementById("askBtn").disabled = true;
  document.getElementById("voiceWave").style.opacity = "0.5";

  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "en-IN"; // Indian English
  
  recognition.onresult = (event) => {
    const question = event.results[0][0].transcript;
    document.getElementById("aiText").innerText = "Searching Policy: " + question;
    
    // Send to Backend
    fetch(`${BACKEND_URL}?action=chat&question=${encodeURIComponent(question)}&name=${encodeURIComponent(userInfo.name)}`, { 
        method: "POST" 
    })
    .then(res => res.json())
    .then(data => {
      // Speak Answer
      speak(data.answer, false, true); 
    })
    .catch(err => {
      speak("Sorry, I couldn't fetch an answer.", false, true);
    });
  };

  recognition.onerror = () => {
    speak("I didn't hear anything. Resuming...", false, true);
  };

  recognition.start();
}

/* ================== SPEAK LOGIC ================== */
function speak(text, autoAdvance = false, resumeAfter = false) {
  if (synth.speaking) synth.cancel();

  const u = new SpeechSynthesisUtterance(text);
  const voices = synth.getVoices();
  u.voice = voices.find(v => v.lang === "en-IN") || voices[0];
  u.rate = 0.95; // Natural speed

  document.getElementById("aiText").innerText = text;

  u.onend = () => {
    if (resumeAfter) {
      isPaused = false;
      document.getElementById("askBtn").innerText = "âœ‹ Push to Ask Doubt";
      document.getElementById("askBtn").disabled = false;
      document.getElementById("voiceWave").style.opacity = "1";
      
      // Resume flow
      speak("Resuming onboarding...", true); 
    }
    else if (autoAdvance && !isPaused) {
      setTimeout(nextStep, 1500); // Pause between steps
    }
  };

  synth.speak(u);
}

// Pre-load voices
window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();

</script>

</body>
</html>